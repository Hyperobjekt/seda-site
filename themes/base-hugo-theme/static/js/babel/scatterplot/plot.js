"use strict";

function _extends() { _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; }; return _extends.apply(this, arguments); }

/* use strict */
(function ($) {
  var plot = {
    scatterplot: null,
    wrappers: [],
    top: null,
    height: null,
    bottom: null,
    isTransitional: false,
    activeState: 'state1',
    // searchItemIDs: [],
    searchEl: null,
    searchProps: {
      // Props passed in to init the search input(s)
      algoliaId: 'QPJ12WSVR4',
      algoliaKey: 'bae9e4604dbd263cc47c48bfb30dd5dc',
      onSuggestionSelected: function onSuggestionSelected(hit) {
        // console.log('hit');
        // console.log(hit);
        searchItemIDs[0] = hit['id']; // console.log(searchItemIDs);

        scatterplot.loadState(plot.activeState); // GA Event submission

        var $highlightedDistrict = '';

        if (!!dataLayer && dataLayer.length >= 3) {
          dataLayer.push({
            'event': 'districtHighlighted',
            'highlightedDistrict': hit['name']
          });
        } else {
          console.log('dataLayer not available. Skipping analytics reporting for highlighted item select.');
        }
      },
      onSelectedClear: function onSelectedClear(e) {
        // console.log(e);
        // Clear search item array
        searchItemIDs = []; // Reload state

        scatterplot.loadState(plot.activeState);
      },
      indices: ['districts'],
      inputProps: {
        placeholder: 'Highlight a district...',
        'aria-label': 'Enter a district name to search'
      }
    },
    renderSearch: function renderSearch() {
      // $elements = $('.search-component');
      // $elements.each(function(el) {
      //   (plot.searchEl).push(new plot.searchInit(plot.searchProps, el));
      // });
      var rootEl = document.getElementById('searchComponent');
      plot.searchEl = new plot.searchInit(plot.searchProps, rootEl);
    },
    searchInit: function searchInit(props, container) {
      var _self = this; // add reference to the component to props


      var refProps = _extends(props, {
        ref: function ref(_ref) {
          _self.component = _ref;
        }
      });

      this.render = function (props) {
        ReactDOM.render(React.createElement(SedaSearch, props, null), container);
      };

      this.render(refProps);
    },
    update: function update() {
      // console.log('update');
      var activeWrappers = $.grep(plot.wrappers, function (el) {
        // Get top and bottom y coords of wrapper
        plot.top = plot.scatterplot.offset().top + 120; // + 462;

        var wrapperTop = $(el).offset().top; // $(el).offset().top - $(window).scrollTop();
        // var wrapperHeight = $(el).height();

        var wrapperHeight = $(el).outerHeight();
        var wrapperBottom = Number(wrapperTop) + Number(wrapperHeight); // If plot top or bottom are within
        // add to activeWrappers.
        // console.log('plot.top = ' + plot.top);
        // console.log('offset().top = ' + $(el).offset().top);
        // console.log('scrolltop = ' + $(window).scrollTop());
        // console.log('wrapperTop = ' + wrapperTop);
        // console.log('wrapperBottom = ' + wrapperBottom);

        if (plot.top >= wrapperTop && plot.top <= wrapperBottom) {
          // console.log('It\'s within a wrapper.');
          return $(el);
        }
      }); // console.log(activeWrappers);

      if (activeWrappers.length == 1) {
        // console.log('One item in activeWrappers.');
        plot.scatterplot.removeClass('transitional');
        plot.isTransitional = false; // Set state to the first one.
        // console.log(activeWrappers[0]);

        var state = $(activeWrappers[0]).attr('data-plot-state');
        var notmerge = $(activeWrappers[0]).attr('data-plot-notmerge') ? $(activeWrappers[0]).attr('data-plot-notmerge') : false; // console.log(
        //     'State = ' + state +
        //     '. Active state = ' + plot.activeState +
        //     '. NotMerge = ' + String(notmerge) + '.' );

        if (state !== plot.activeState) {
          console.log('loading new state ' + state);

          if (notmerge) {
            scatterplot.loadState(state, {
              notMerge: true
            });
          } else {
            scatterplot.loadState(state);
          }

          plot.activeState = state;
        }
      } else if (activeWrappers.length === 0 || activeWrappers.length >= 1) {
        plot.scatterplot.addClass('transitional');
        plot.isTransitional = true; // console.log('In transition. State = ' + state);
      }
    },
    getCoords: function getCoords() {
      plot.top = plot.scatterplot.offset().top;
      plot.height = plot.scatterplot.find('> div').height();
      plot.bottom = Number(plot.top) + Number(plot.height);
    }
  }; // Get top and bottom y coords of the scatterplot

  plot.scatterplot = $('#scatterplot');
  plot.wrappers = $('.state-desc-wrapper');
  plot.getCoords(); // Reset them if the screen is resized

  $(window).resize(function () {
    // plot.top = (plot.scatterplot).offset().top;
    // plot.height = (plot.scatterplot).find('> div').height();
    // plot.bottom = Number(plot.top) + Number(plot.height);
    plot.getCoords();
  }); // Only trigger scroll ever 50ms so less resources

  scatterplot.on('ready', function (scatterplot) {
    var userScrolled = false;
    $(window).scroll(function () {
      userScrolled = true;
    });
    setInterval(function () {
      if (userScrolled) {
        plot.update(); // @lane, disabled default scroll event init here.

        userScrolled = false;
      }
    }, 50);

    if ($('.search-component').length >= 1) {
      plot.renderSearch();
    }
  });
  scatterplot.loadState('state1');
})(jQuery);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NjYXR0ZXJwbG90L3Bsb3QuanMiXSwibmFtZXMiOlsiJCIsInBsb3QiLCJzY2F0dGVycGxvdCIsIndyYXBwZXJzIiwidG9wIiwiaGVpZ2h0IiwiYm90dG9tIiwiaXNUcmFuc2l0aW9uYWwiLCJhY3RpdmVTdGF0ZSIsInNlYXJjaEVsIiwic2VhcmNoUHJvcHMiLCJhbGdvbGlhSWQiLCJhbGdvbGlhS2V5Iiwib25TdWdnZXN0aW9uU2VsZWN0ZWQiLCJoaXQiLCJzZWFyY2hJdGVtSURzIiwibG9hZFN0YXRlIiwiJGhpZ2hsaWdodGVkRGlzdHJpY3QiLCJkYXRhTGF5ZXIiLCJsZW5ndGgiLCJwdXNoIiwiY29uc29sZSIsImxvZyIsIm9uU2VsZWN0ZWRDbGVhciIsImUiLCJpbmRpY2VzIiwiaW5wdXRQcm9wcyIsInBsYWNlaG9sZGVyIiwicmVuZGVyU2VhcmNoIiwicm9vdEVsIiwiZG9jdW1lbnQiLCJnZXRFbGVtZW50QnlJZCIsInNlYXJjaEluaXQiLCJwcm9wcyIsImNvbnRhaW5lciIsIl9zZWxmIiwicmVmUHJvcHMiLCJyZWYiLCJjb21wb25lbnQiLCJyZW5kZXIiLCJSZWFjdERPTSIsIlJlYWN0IiwiY3JlYXRlRWxlbWVudCIsIlNlZGFTZWFyY2giLCJ1cGRhdGUiLCJhY3RpdmVXcmFwcGVycyIsImdyZXAiLCJlbCIsIm9mZnNldCIsIndyYXBwZXJUb3AiLCJ3cmFwcGVySGVpZ2h0Iiwib3V0ZXJIZWlnaHQiLCJ3cmFwcGVyQm90dG9tIiwiTnVtYmVyIiwicmVtb3ZlQ2xhc3MiLCJzdGF0ZSIsImF0dHIiLCJub3RtZXJnZSIsIm5vdE1lcmdlIiwiYWRkQ2xhc3MiLCJnZXRDb29yZHMiLCJmaW5kIiwid2luZG93IiwicmVzaXplIiwib24iLCJ1c2VyU2Nyb2xsZWQiLCJzY3JvbGwiLCJzZXRJbnRlcnZhbCIsImpRdWVyeSJdLCJtYXBwaW5ncyI6Ijs7OztBQUFBO0FBRUEsQ0FBQyxVQUFTQSxDQUFULEVBQVk7QUFFVCxNQUFNQyxJQUFJLEdBQUc7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dGlvbigkKSB7XG5cbiAgICBjb25zdCBwbG90ID0ge1xuICAgICAgICBzY2F0dGVycGxvdDogbnVsbCxcbiAgICAgICAgd3JhcHBlcnM6IFtdLFxuICAgICAgICB0b3A6IG51bGwsXG4gICAgICAgIGhlaWdodDogbnVsbCxcbiAgICAgICAgYm90dG9tOiBudWxsLFxuICAgICAgICBpc1RyYW5zaXRpb25hbDogZmFsc2UsXG4gICAgICAgIGFjdGl2ZVN0YXRlOiAnc3RhdGUxJyxcbiAgICAgICAgLy8gc2VhcmNoSXRlbUlEczogW10sXG4gICAgICAgIHNlYXJjaEVsOiBudWxsLFxuICAgICAgICBzZWFyY2hQcm9wczogeyAvLyBQcm9wcyBwYXNzZWQgaW4gdG8gaW5pdCB0aGUgc2VhcmNoIGlucHV0KHMpXG4gICAgICAgICAgYWxnb2xpYUlkOiAnUVBKMTJXU1ZSNCcsXG4gICAgICAgICAgYWxnb2xpYUtleTogJ2JhZTllNDYwNGRiZDI2M2NjNDdjNDhiZmIzMGRkNWRjJyxcbiAgICAgICAgICBvblN1Z2dlc3Rpb25TZWxlY3RlZDogZnVuY3Rpb24oaGl0KSB7XG4gICAgICAgICAgICAvLyBjb25zb2xlLmxvZygnaGl0Jyk7XG4gICAgICAgICAgICAvLyBjb25zb2xlLmxvZyhoaXQpO1xuICAgICAgICAgICAgc2VhcmNoSXRlbUlEc1swXSA9IGhpdFsnaWQnXTtcbiAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKHNlYXJjaEl0ZW1JRHMpO1xuICAgICAgICAgICAgc2NhdHRlcnBsb3QubG9hZFN0YXRlKHBsb3QuYWN0aXZlU3RhdGUpO1xuICAgICAgICAgICAgLy8gR0EgRXZlbnQgc3VibWlzc2lvblxuICAgICAgICAgICAgY29uc3QgJGhpZ2hsaWdodGVkRGlzdHJpY3QgPSAnJztcbiAgICAgICAgICAgIGlmICghIWRhdGFMYXllciAmJiAoZGF0YUxheWVyLmxlbmd0aCA+PSAzKSkge1xuICAgICAgICAgICAgICBkYXRhTGF5ZXIucHVzaCh7XG4gICAgICAgICAgICAgICAgJ2V2ZW50JzogJ2Rpc3RyaWN0SGlnaGxpZ2h0ZWQnLFxuICAgICAgICAgICAgICAgICdoaWdobGlnaHRlZERpc3RyaWN0JzogaGl0WyduYW1lJ11cbiAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICBjb25zb2xlLmxvZygnZGF0YUxheWVyIG5vdCBhdmFpbGFibGUuIFNraXBwaW5nIGFuYWx5dGljcyByZXBvcnRpbmcgZm9yIGhpZ2hsaWdodGVkIGl0ZW0gc2VsZWN0LicpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0sXG4gICAgICAgICAgb25TZWxlY3RlZENsZWFyOiBmdW5jdGlvbihlKSB7XG4gICAgICAgICAgICAvLyBjb25zb2xlLmxvZyhlKTtcbiAgICAgICAgICAgIC8vIENsZWFyIHNlYXJjaCBpdGVtIGFycmF5XG4gICAgICAgICAgICBzZWFyY2hJdGVtSURzID0gW107XG4gICAgICAgICAgICAvLyBSZWxvYWQgc3RhdGVcbiAgICAgICAgICAgIHNjYXR0ZXJwbG90LmxvYWRTdGF0ZShwbG90LmFjdGl2ZVN0YXRlKTtcbiAgICAgICAgICB9LFxuICAgICAgICAgIGluZGljZXM6IFsnZGlzdHJpY3RzJ10sXG4gICAgICAgICAgaW5wdXRQcm9wczoge1xuICAgICAgICAgICAgcGxhY2Vob2xkZXI6ICdIaWdobGlnaHQgYSBkaXN0cmljdC4uLicsXG4gICAgICAgICAgICAnYXJpYS1sYWJlbCc6ICdFbnRlciBhIGRpc3RyaWN0IG5hbWUgdG8gc2VhcmNoJ1xuICAgICAgICAgIH1cbiAgICAgICAgfSxcbiAgICAgICAgcmVuZGVyU2VhcmNoOiBmdW5jdGlvbigpIHtcbiAgICAgICAgICAvLyAkZWxlbWVudHMgPSAkKCcuc2VhcmNoLWNvbXBvbmVudCcpO1xuICAgICAgICAgIC8vICRlbGVtZW50cy5lYWNoKGZ1bmN0aW9uKGVsKSB7XG4gICAgICAgICAgLy8gICAocGxvdC5zZWFyY2hFbCkucHVzaChuZXcgcGxvdC5zZWFyY2hJbml0KHBsb3Quc2VhcmNoUHJvcHMsIGVsKSk7XG4gICAgICAgICAgLy8gfSk7XG4gICAgICAgICAgdmFyIHJvb3RFbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzZWFyY2hDb21wb25lbnQnKTtcbiAgICAgICAgICBwbG90LnNlYXJjaEVsID0gbmV3IHBsb3Quc2VhcmNoSW5pdChwbG90LnNlYXJjaFByb3BzLCByb290RWwpO1xuICAgICAgICB9LFxuICAgICAgICBzZWFyY2hJbml0OiBmdW5jdGlvbihwcm9wcywgY29udGFpbmVyKSB7XG4gICAgICAgICAgdmFyIF9zZWxmID0gdGhpcztcblxuICAgICAgICAgIC8vIGFkZCByZWZlcmVuY2UgdG8gdGhlIGNvbXBvbmVudCB0byBwcm9wc1xuICAgICAgICAgIHZhciByZWZQcm9wcyA9IE9iamVjdC5hc3NpZ24ocHJvcHMsIHtcbiAgICAgICAgICAgIHJlZjogZnVuY3Rpb24ocmVmKSB7IF9zZWxmLmNvbXBvbmVudCA9IHJlZjsgfVxuICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgdGhpcy5yZW5kZXIgPSBmdW5jdGlvbihwcm9wcykge1xuICAgICAgICAgICAgUmVhY3RET00ucmVuZGVyKFxuICAgICAgICAgICAgICBSZWFjdC5jcmVhdGVFbGVtZW50KFNlZGFTZWFyY2gsIHByb3BzLCBudWxsKSxcbiAgICAgICAgICAgICAgY29udGFpbmVyXG4gICAgICAgICAgICApO1xuICAgICAgICAgIH1cbiAgICAgICAgICB0aGlzLnJlbmRlcihyZWZQcm9wcyk7XG4gICAgICAgIH0sXG4gICAgICAgIHVwZGF0ZTogZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAvLyBjb25zb2xlLmxvZygndXBkYXRlJyk7XG4gICAgICAgICAgICB2YXIgYWN0aXZlV3JhcHBlcnMgPSAkLmdyZXAocGxvdC53cmFwcGVycywgZnVuY3Rpb24oZWwpIHtcbiAgICAgICAgICAgICAgICAvLyBHZXQgdG9wIGFuZCBib3R0b20geSBjb29yZHMgb2Ygd3JhcHBlclxuICAgICAgICAgICAgICAgIHBsb3QudG9wID0gKHBsb3Quc2NhdHRlcnBsb3QpLm9mZnNldCgpLnRvcCArIDEyMDsgLy8gKyA0NjI7XG4gICAgICAgICAgICAgICAgdmFyIHdyYXBwZXJUb3AgPSAkKGVsKS5vZmZzZXQoKS50b3A7IC8vICQoZWwpLm9mZnNldCgpLnRvcCAtICQod2luZG93KS5zY3JvbGxUb3AoKTtcbiAgICAgICAgICAgICAgICAvLyB2YXIgd3JhcHBlckhlaWdodCA9ICQoZWwpLmhlaWdodCgpO1xuICAgICAgICAgICAgICAgIHZhciB3cmFwcGVySGVpZ2h0ID0gJChlbCkub3V0ZXJIZWlnaHQoKTtcbiAgICAgICAgICAgICAgICB2YXIgd3JhcHBlckJvdHRvbSA9IE51bWJlcih3cmFwcGVyVG9wKSArIE51bWJlcih3cmFwcGVySGVpZ2h0KTtcbiAgICAgICAgICAgICAgICAvLyBJZiBwbG90IHRvcCBvciBib3R0b20gYXJlIHdpdGhpblxuICAgICAgICAgICAgICAgIC8vIGFkZCB0byBhY3RpdmVXcmFwcGVycy5cbiAgICAgICAgICAgICAgICAvLyBjb25zb2xlLmxvZygncGxvdC50b3AgPSAnICsgcGxvdC50b3ApO1xuICAgICAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKCdvZmZzZXQoKS50b3AgPSAnICsgJChlbCkub2Zmc2V0KCkudG9wKTtcbiAgICAgICAgICAgICAgICAvLyBjb25zb2xlLmxvZygnc2Nyb2xsdG9wID0gJyArICQod2luZG93KS5zY3JvbGxUb3AoKSk7XG4gICAgICAgICAgICAgICAgLy8gY29uc29sZS5sb2coJ3dyYXBwZXJUb3AgPSAnICsgd3JhcHBlclRvcCk7XG4gICAgICAgICAgICAgICAgLy8gY29uc29sZS5sb2coJ3dyYXBwZXJCb3R0b20gPSAnICsgd3JhcHBlckJvdHRvbSk7XG4gICAgICAgICAgICAgICAgaWYgKChwbG90LnRvcCA+PSB3cmFwcGVyVG9wICYmIHBsb3QudG9wIDw9IHdyYXBwZXJCb3R0b20pKSB7XG4gICAgICAgICAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKCdJdFxcJ3Mgd2l0aGluIGEgd3JhcHBlci4nKTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICQoZWwpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgLy8gY29uc29sZS5sb2coYWN0aXZlV3JhcHBlcnMpO1xuICAgICAgICAgICAgaWYgKGFjdGl2ZVdyYXBwZXJzLmxlbmd0aCA9PSAxKSB7XG4gICAgICAgICAgICAgICAgLy8gY29uc29sZS5sb2coJ09uZSBpdGVtIGluIGFjdGl2ZVdyYXBwZXJzLicpO1xuICAgICAgICAgICAgICAgIChwbG90LnNjYXR0ZXJwbG90KS5yZW1vdmVDbGFzcygndHJhbnNpdGlvbmFsJyk7XG4gICAgICAgICAgICAgICAgcGxvdC5pc1RyYW5zaXRpb25hbCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIC8vIFNldCBzdGF0ZSB0byB0aGUgZmlyc3Qgb25lLlxuICAgICAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKGFjdGl2ZVdyYXBwZXJzWzBdKTtcbiAgICAgICAgICAgICAgICB2YXIgc3RhdGUgPSAkKGFjdGl2ZVdyYXBwZXJzWzBdKS5hdHRyKCdkYXRhLXBsb3Qtc3RhdGUnKTtcbiAgICAgICAgICAgICAgICB2YXIgbm90bWVyZ2UgPVxuICAgICAgICAgICAgICAgICAgICAkKGFjdGl2ZVdyYXBwZXJzWzBdKS5hdHRyKCdkYXRhLXBsb3Qtbm90bWVyZ2UnKSA/XG4gICAgICAgICAgICAgICAgICAgICQoYWN0aXZlV3JhcHBlcnNbMF0pLmF0dHIoJ2RhdGEtcGxvdC1ub3RtZXJnZScpIDpcbiAgICAgICAgICAgICAgICAgICAgZmFsc2U7XG4gICAgICAgICAgICAgICAgLy8gY29uc29sZS5sb2coXG4gICAgICAgICAgICAgICAgLy8gICAgICdTdGF0ZSA9ICcgKyBzdGF0ZSArXG4gICAgICAgICAgICAgICAgLy8gICAgICcuIEFjdGl2ZSBzdGF0ZSA9ICcgKyBwbG90LmFjdGl2ZVN0YXRlICtcbiAgICAgICAgICAgICAgICAvLyAgICAgJy4gTm90TWVyZ2UgPSAnICsgU3RyaW5nKG5vdG1lcmdlKSArICcuJyApO1xuICAgICAgICAgICAgICAgIGlmIChzdGF0ZSAhPT0gcGxvdC5hY3RpdmVTdGF0ZSkge1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnbG9hZGluZyBuZXcgc3RhdGUgJyArIHN0YXRlKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKG5vdG1lcmdlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzY2F0dGVycGxvdC5sb2FkU3RhdGUoc3RhdGUsIHtub3RNZXJnZTogdHJ1ZX0pO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgc2NhdHRlcnBsb3QubG9hZFN0YXRlKHN0YXRlKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBwbG90LmFjdGl2ZVN0YXRlID0gc3RhdGU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlIGlmIChhY3RpdmVXcmFwcGVycy5sZW5ndGggPT09IDAgfHwgYWN0aXZlV3JhcHBlcnMubGVuZ3RoID49IDEpIHtcbiAgICAgICAgICAgICAgICAocGxvdC5zY2F0dGVycGxvdCkuYWRkQ2xhc3MoJ3RyYW5zaXRpb25hbCcpO1xuICAgICAgICAgICAgICAgIHBsb3QuaXNUcmFuc2l0aW9uYWwgPSB0cnVlO1xuICAgICAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKCdJbiB0cmFuc2l0aW9uLiBTdGF0ZSA9ICcgKyBzdGF0ZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0sXG4gICAgICAgIGdldENvb3JkczogZnVuY3Rpb24oKSB7XG4gICAgICAgICAgcGxvdC50b3AgPSAocGxvdC5zY2F0dGVycGxvdCkub2Zmc2V0KCkudG9wO1xuICAgICAgICAgIHBsb3QuaGVpZ2h0ID0gKHBsb3Quc2NhdHRlcnBsb3QpLmZpbmQoJz4gZGl2JykuaGVpZ2h0KCk7XG4gICAgICAgICAgcGxvdC5ib3R0b20gPSBOdW1iZXIocGxvdC50b3ApICsgTnVtYmVyKHBsb3QuaGVpZ2h0KTtcbiAgICAgICAgfVxuICAgIH07XG5cbiAgICAvLyBHZXQgdG9wIGFuZCBib3R0b20geSBjb29yZHMgb2YgdGhlIHNjYXR0ZXJwbG90XG4gICAgcGxvdC5zY2F0dGVycGxvdCA9ICQoJyNzY2F0dGVycGxvdCcpO1xuICAgIHBsb3Qud3JhcHBlcnMgPSAkKCcuc3RhdGUtZGVzYy13cmFwcGVyJyk7XG4gICAgcGxvdC5nZXRDb29yZHMoKTtcblxuICAgIC8vIFJlc2V0IHRoZW0gaWYgdGhlIHNjcmVlbiBpcyByZXNpemVkXG4gICAgJCggd2luZG93ICkucmVzaXplKGZ1bmN0aW9uKCkge1xuICAgICAgICAvLyBwbG90LnRvcCA9IChwbG90LnNjYXR0ZXJwbG90KS5vZmZzZXQoKS50b3A7XG4gICAgICAgIC8vIHBsb3QuaGVpZ2h0ID0gKHBsb3Quc2NhdHRlcnBsb3QpLmZpbmQoJz4gZGl2JykuaGVpZ2h0KCk7XG4gICAgICAgIC8vIHBsb3QuYm90dG9tID0gTnVtYmVyKHBsb3QudG9wKSArIE51bWJlcihwbG90LmhlaWdodCk7XG4gICAgICAgIHBsb3QuZ2V0Q29vcmRzKCk7XG4gICAgfSk7XG5cbiAgICAvLyBPbmx5IHRyaWdnZXIgc2Nyb2xsIGV2ZXIgNTBtcyBzbyBsZXNzIHJlc291cmNlc1xuICAgIHNjYXR0ZXJwbG90Lm9uKCdyZWFkeScsIGZ1bmN0aW9uKHNjYXR0ZXJwbG90KSB7XG4gICAgICAgIHZhciB1c2VyU2Nyb2xsZWQgPSBmYWxzZTtcbiAgICAgICAgJCh3aW5kb3cpLnNjcm9sbChmdW5jdGlvbigpIHtcbiAgICAgICAgICB1c2VyU2Nyb2xsZWQgPSB0cnVlO1xuICAgICAgICB9KTtcbiAgICAgICAgc2V0SW50ZXJ2YWwoZnVuY3Rpb24oKSB7XG4gICAgICAgICAgaWYgKHVzZXJTY3JvbGxlZCkge1xuICAgICAgICAgICAgcGxvdC51cGRhdGUoKTsgLy8gQGxhbmUsIGRpc2FibGVkIGRlZmF1bHQgc2Nyb2xsIGV2ZW50IGluaXQgaGVyZS5cbiAgICAgICAgICAgIHVzZXJTY3JvbGxlZCA9IGZhbHNlO1xuICAgICAgICAgIH1cbiAgICAgICAgfSwgNTApO1xuXG4gICAgICAgIGlmICgkKCcuc2VhcmNoLWNvbXBvbmVudCcpLmxlbmd0aCA+PSAxKSB7XG4gICAgICAgICAgcGxvdC5yZW5kZXJTZWFyY2goKTtcbiAgICAgICAgfVxuICAgIH0pO1xuICAgIHNjYXR0ZXJwbG90LmxvYWRTdGF0ZSgnc3RhdGUxJyk7XG59KShqUXVlcnkpO1xuIl19